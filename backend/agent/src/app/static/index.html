<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clinical AE Assessment</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border-radius: 12px;
        padding: 40px 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .header h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .header p {
        color: #666;
        font-size: 1.1em;
      }

      .assessments-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .assessment-item {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .assessment-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.3s ease;
      }

      .assessment-header:hover {
        background: linear-gradient(135deg, #5568d3 0%, #683a8d 100%);
      }

      .assessment-header h3 {
        font-size: 1.2em;
        flex: 1;
      }

      .assessment-header p {
        font-size: 0.9em;
        opacity: 0.9;
        margin-right: 20px;
      }

      .toggle-icon {
        font-size: 1.5em;
        transition: transform 0.3s ease;
      }

      .assessment-item.expanded .toggle-icon {
        transform: rotate(180deg);
      }

      .assessment-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .assessment-item.expanded .assessment-content {
        max-height: 2000px;
      }

      .assessment-body {
        padding: 30px;
      }

      .assessment-details {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .detail-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 20px;
        margin-bottom: 12px;
        align-items: start;
      }

      .detail-label {
        font-weight: 600;
        color: #667eea;
        font-size: 0.95em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .detail-value {
        color: #555;
        word-break: break-word;
      }

      .run-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 10px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .button-group button {
        flex: 1;
      }

      .view-button {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .view-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(39, 174, 96, 0.4);
      }

      .view-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .run-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .run-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .assessment-data {
        background: #f9f9f9;
        border-left: 4px solid #27ae60;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
      }

      .assessment-data.show {
        display: block;
      }

      .assessment-data h5 {
        color: #27ae60;
        margin-bottom: 10px;
        font-size: 0.95em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .assessment-data pre {
        margin: 0;
        background: white;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 0.85em;
        border: 1px solid #e0e0e0;
      }

      .results {
        background: #f8f9ff;
        border-left: 4px solid #667eea;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
      }

      .results.show {
        display: block;
      }

      .results h4 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.1em;
      }

      .result-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 20px;
        margin-bottom: 15px;
        align-items: start;
      }

      .result-label {
        font-weight: 600;
        color: #667eea;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .result-value {
        color: #333;
        line-height: 1.6;
        word-break: break-word;
      }

      .result-value pre {
        margin: 0;
        background: #f5f5f5;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
      }

      .result-value.true {
        color: #27ae60;
        font-weight: 600;
      }

      .result-value.false {
        color: #e74c3c;
        font-weight: 600;
      }

      .criteria-list {
        background: white;
        padding: 12px;
        border-radius: 6px;
        list-style: none;
        border-left: 3px solid #667eea;
      }

      .criteria-list li {
        padding: 8px 0;
        color: #555;
        border-bottom: 1px solid #f0f0f0;
      }

      .criteria-list li:last-child {
        border-bottom: none;
      }

      .confidence-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        display: inline-block;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fee;
        border-left: 4px solid #e74c3c;
        padding: 15px;
        border-radius: 8px;
        color: #c0392b;
        display: none;
        margin-bottom: 20px;
      }

      .error.show {
        display: block;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state p {
        font-size: 1.1em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üè• Clinical AE Assessment</h1>
        <p>Adverse Event Detection Using AI</p>
      </div>

      <div class="error" id="globalError"></div>

      <div class="assessments-container" id="assessmentsContainer"></div>

      <div class="empty-state" id="emptyState">
        <p>Loading assessments...</p>
      </div>
    </div>

    <script>
      let TESTS = [];
      let assessmentStates = {};

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadTestAssessments();
      });

      async function loadTestAssessments() {
        try {
          const response = await fetch("/api/test-assessments");
          const data = await response.json();
          TESTS = data.assessments || [];
          renderAssessments();
        } catch (error) {
          console.error("Error loading assessments:", error);
          document.getElementById("emptyState").innerHTML =
            "<p>Error loading assessments. Please refresh the page.</p>";
        }
      }

      function renderAssessments() {
        const container = document.getElementById("assessmentsContainer");
        const emptyState = document.getElementById("emptyState");

        if (TESTS.length === 0) {
          emptyState.style.display = "block";
          return;
        }

        emptyState.style.display = "none";

        container.innerHTML = TESTS.map((test, idx) => {
          assessmentStates[idx] = {
            expanded: false,
            loading: false,
            result: null,
            assessmentData: null,
            dataShown: false,
          };
          return `
                    <div class="assessment-item" id="assessment-${idx}">
                        <div class="assessment-header" onclick="toggleAssessment(${idx})">
                            <div>
                                <h3>${test.name}</h3>
                                <p>${test.description}</p>
                            </div>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="assessment-content">
                            <div class="assessment-body">
                                <div id="error-${idx}" class="error"></div>

                                <div class="assessment-details">
                                    <div class="detail-row">
                                        <div class="detail-label">Test Name</div>
                                        <div class="detail-value">${test.name}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="detail-label">File</div>
                                        <div class="detail-value">${test.file}</div>
                                    </div>
                                </div>

                                <button class="run-button" id="run-btn-${idx}" onclick="runAssessment(${idx})">
                                    ‚ñ∂ Run Assessment
                                </button>

                                <div class="button-group">
                                    <button class="view-button" id="view-btn-${idx}" onclick="toggleAssessmentData(${idx})">
                                        üìÑ View Assessment
                                    </button>
                                </div>

                                <div class="assessment-data" id="assessment-data-${idx}">
                                    <h5>Input Assessment Data</h5>
                                    <pre id="assessment-json-${idx}">Loading...</pre>
                                </div>

                                <div class="loading" id="loading-${idx}">
                                    <div class="spinner"></div>
                                    <p>Analyzing assessment...</p>
                                </div>

                                <div class="results" id="results-${idx}"></div>
                            </div>
                        </div>
                    </div>
                `;
        }).join("");
      }

      function toggleAssessment(idx) {
        const item = document.getElementById(`assessment-${idx}`);
        const isExpanded = assessmentStates[idx].expanded;

        assessmentStates[idx].expanded = !isExpanded;

        if (!isExpanded) {
          item.classList.add("expanded");
        } else {
          item.classList.remove("expanded");
        }
      }

      function toggleAssessmentData(idx) {
        const dataDiv = document.getElementById(`assessment-data-${idx}`);
        const jsonDiv = document.getElementById(`assessment-json-${idx}`);

        if (!dataDiv || !jsonDiv) {
          console.error(`Elements not found for assessment ${idx}`);
          return;
        }

        if (assessmentStates[idx].dataShown) {
          dataDiv.classList.remove("show");
          assessmentStates[idx].dataShown = false;
        } else {
          if (assessmentStates[idx].assessmentData) {
            jsonDiv.textContent = JSON.stringify(
              assessmentStates[idx].assessmentData,
              null,
              2,
            );
            dataDiv.classList.add("show");
            assessmentStates[idx].dataShown = true;
          } else {
            alert("Assessment data not yet loaded. Run the assessment first.");
          }
        }
      }

      async function runAssessment(idx) {
        const test = TESTS[idx];
        const runBtn = document.getElementById(`run-btn-${idx}`);
        const loading = document.getElementById(`loading-${idx}`);
        const resultsDiv = document.getElementById(`results-${idx}`);
        const errorDiv = document.getElementById(`error-${idx}`);

        // Clear previous error and results
        errorDiv.classList.remove("show");
        resultsDiv.classList.remove("show");
        resultsDiv.innerHTML = "";

        runBtn.disabled = true;
        loading.classList.add("show");
        assessmentStates[idx].loading = true;

        try {
          // Fetch the test file
          const response = await fetch(`/api/test-assessment/${test.file}`);
          if (!response.ok)
            throw new Error(`Failed to load test file: ${response.statusText}`);
          const assessmentData = await response.json();

          // Store the assessment data for viewing
          assessmentStates[idx].assessmentData = assessmentData;

          // Call the assessment endpoint
          const assessResponse = await fetch(`/assessment`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(assessmentData),
          });

          if (!assessResponse.ok) {
            const errorData = await assessResponse.json();
            throw new Error(errorData.detail || "Assessment failed");
          }

          const result = await assessResponse.json();
          assessmentStates[idx].result = result;
          displayResults(idx, result);
        } catch (error) {
          showError(idx, error.message);
        } finally {
          runBtn.disabled = false;
          loading.classList.remove("show");
          assessmentStates[idx].loading = false;
        }
      }

      function displayResults(idx, result) {
        const resultsDiv = document.getElementById(`results-${idx}`);

        console.log("Full Result:", result);

        // Extract decision data - handle nested decision object
        const decision = result.decision || result;
        const isAdverse = decision.is_adverse_event || false;
        const confidence = (decision.confidence || 0) * 100;
        const explanation = decision.explanation || "No explanation provided";
        const reasoning = decision.reasoning || "";
        const matchedCriteria = decision.matched_criteria || [];
        const nextSteps = decision.recommended_next_steps || [];
        const source = result.source || "inline";
        const trace = result.trace_run_id || "";
        const therapy = result.therapy || "";
        const contractContext = result.contract_context_preview || "";
        const filteredQuestions = result.filtered_important_questions;

        let html = `
                <h4>üìä Assessment Results</h4>
                <div class="result-row">
                    <div class="result-label">Status</div>
                    <div class="result-value ${isAdverse ? "true" : "false"}">
                        ${isAdverse ? "üî¥ ADVERSE EVENT DETECTED" : "üü¢ NO ADVERSE EVENT"}
                    </div>
                </div>
                <div class="result-row">
                    <div class="result-label">Confidence</div>
                    <div class="result-value">
                        <span class="confidence-badge">${confidence.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="result-row">
                    <div class="result-label">Explanation</div>
                    <div class="result-value">${explanation}</div>
                </div>
            `;

        if (reasoning && reasoning.trim()) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Reasoning</div>
                        <div class="result-value">${reasoning}</div>
                    </div>
                `;
        }

        if (matchedCriteria && matchedCriteria.length > 0) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Criteria Met</div>
                        <div class="result-value">
                            <ul class="criteria-list">
                                ${matchedCriteria.map((c) => `<li>‚úì ${c}</li>`).join("")}
                            </ul>
                        </div>
                    </div>
                `;
        }

        if (nextSteps && nextSteps.length > 0) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Next Steps</div>
                        <div class="result-value">
                            <ul class="criteria-list">
                                ${nextSteps.map((s) => `<li>‚Üí ${s}</li>`).join("")}
                            </ul>
                        </div>
                    </div>
                `;
        }

        if (source) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Source</div>
                        <div class="result-value">${source}</div>
                    </div>
                `;
        }

        if (therapy) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Therapy</div>
                        <div class="result-value">${therapy}</div>
                    </div>
                `;
        }

        if (contractContext) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Contract Context</div>
                        <div class="result-value" style="font-size: 0.9em; background: #f9f9f9; padding: 10px; border-radius: 6px; border-left: 3px solid #667eea;">${contractContext}</div>
                    </div>
                `;
        }

        if (trace) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Trace ID</div>
                        <div class="result-value" style="font-family: monospace; font-size: 0.85em;">${trace}</div>
                    </div>
                `;
        }

        // Show any other fields not in the known list
        const knownFields = [
          "decision",
          "source",
          "trace_run_id",
          "therapy",
          "contract_context_preview",
          "filtered_important_questions",
        ];
        const otherFields = Object.keys(result).filter(
          (k) => !knownFields.includes(k),
        );

        if (otherFields.length > 0) {
          html += `
                    <div class="result-row">
                        <div class="result-label">Additional Data</div>
                        <div class="result-value">
                            <ul class="criteria-list">
                                ${otherFields.map((field) => `<li><strong>${field}:</strong> ${JSON.stringify(result[field])}</li>`).join("")}
                            </ul>
                        </div>
                    </div>
                `;
        }

        // Show raw JSON
        html += `
                    <div class="result-row">
                        <div class="result-label">Raw JSON</div>
                        <div class="result-value" style="background: #f5f5f5; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.85em; max-height: 200px; overflow-y: auto;">
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    </div>
                `;

        resultsDiv.innerHTML = html;
        resultsDiv.classList.add("show");
      }

      function showError(idx, message) {
        const errorDiv = document.getElementById(`error-${idx}`);
        errorDiv.textContent = message;
        errorDiv.classList.add("show");
      }
    </script>
  </body>
</html>
